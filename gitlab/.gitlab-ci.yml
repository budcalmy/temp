default:
  artifacts:
    expire_in: "2 days"
  cache:
    policy: pull-push

stages:
  - build
  - deploy
  - cleanup

variables:
  DOCKER_BUILDKIT: "1"
  DOCKER_REGISTRY: "docker.io"

  DOCKER_NGINX_IMAGE: "$DOCKERHUB_USERNAME/task18-nginx"
  DOCKER_APACHE_IMAGE: "$DOCKERHUB_USERNAME/task18-apache"

  K8S_DEPLOYMENT_NAME_NGINX: "nginx-deploy"
  K8S_DEPLOYMENT_NAME_APACHE: "apache-deploy"

  K8S_CONTAINER_NAME_NGINX: "nginx"
  K8S_CONTAINER_NAME_APACHE: "apache-main"

  K8S_NAMESPACE_DEV: "dev"
  K8S_NAMESPACE_PROD: "prod"

  HELM_VALUES_PATH_DEV_NGINX: "helm/nginx/values.yaml"
  HELM_VALUES_PATH_DEV_APACHE: "helm/apache/values.yaml"

  HELM_VALUES_PATH_PROD_NGINX: "helm/nginx/prod-values.yml"
  HELM_VALUES_PATH_PROD_APACHE: "helm/apache/prod-values.yml"

build-and-push-images:
  stage: build
  tags:
    - macos-runner
  rules:
    - if: '$CI_COMMIT_BRANCH == "dev"'
  before_script:
    - echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
  script:
    - docker buildx create --name multiarch --use || docker buildx use multiarch
    - docker buildx inspect --bootstrap
    - |
      docker buildx build \
        --platform linux/amd64 \
        -t "$DOCKER_NGINX_IMAGE:$CI_COMMIT_SHORT_SHA" \
        -t "$DOCKER_NGINX_IMAGE:latest" \
        --push ./src/.
  after_script:
    - docker logout

deploy-dev:
  stage: deploy
  tags:
    - macos-runner
  needs:
    - job: build-and-push-images
      artifacts: false
  rules:
    - if: '$CI_COMMIT_BRANCH == "dev"'
  before_script:
    - kubectl create namespace "$K8S_NAMESPACE_DEV" --dry-run=client -o yaml | kubectl apply -f -
  script:
    - helm upgrade --install "$K8S_DEPLOYMENT_NAME_NGINX" ./helm/nginx --namespace "$K8S_NAMESPACE_DEV" --values "$HELM_VALUES_PATH_DEV_NGINX" --set image.repository="$DOCKER_NGINX_IMAGE" --set image.tag="$CI_COMMIT_SHORT_SHA"
    - helm upgrade --install "$K8S_DEPLOYMENT_NAME_APACHE" ./helm/apache --namespace "$K8S_NAMESPACE_DEV" --values "$HELM_VALUES_PATH_DEV_APACHE" --set image.repository="$DOCKER_APACHE_IMAGE" --set image.tag="$CI_COMMIT_SHORT_SHA"

deploy-prod:
  stage: deploy
  image: dtzar/helm-kubectl:3.12.0
  needs:
    - job: build-and-push-images
      artifacts: false
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main"'
  before_script:
    - kubectl create namespace "$K8S_NAMESPACE_PROD" --dry-run=client -o yaml | kubectl apply -f -
  script:
    - helm upgrade --install "$K8S_DEPLOYMENT_NAME_NGINX" ./helm/nginx --namespace "$K8S_NAMESPACE_PROD" --values "$HELM_VALUES_PATH_PROD_NGINX" --set image.repository="$DOCKER_NGINX_IMAGE" --set image.tag="$CI_COMMIT_SHORT_SHA"
    - helm upgrade --install "$K8S_DEPLOYMENT_NAME_APACHE" ./helm/apache --namespace "$K8S_NAMESPACE_PROD" --values "$HELM_VALUES_PATH_PROD_APACHE" --set image.repository="$DOCKER_APACHE_IMAGE" --set image.tag="$CI_COMMIT_SHORT_SHA"


cleanup:
  stage: cleanup
  tags:
    - macos-runner
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
    - if: '$CI_COMMIT_BRANCH == "dev"'
  script:
    - echo "Cleaning only images related to projectâ€¦"

    - docker images || true

    - |
      for IMG in $(docker images "$DOCKER_NGINX_IMAGE" --format "{{.Repository}}:{{.Tag}}"); do
        echo "Removing $IMG..."
        docker rmi -f "$IMG" || true
      done

    - |
      for IMG in $(docker images "$DOCKER_APACHE_IMAGE" --format "{{.Repository}}:{{.Tag}}"); do
        echo "Removing $IMG..."
        docker rmi -f "$IMG" || true
      done

    - docker buildx prune -f --filter "unused-for=72h" || true

    - docker builder prune -f || true

